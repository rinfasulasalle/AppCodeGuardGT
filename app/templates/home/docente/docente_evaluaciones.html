{% extends "layouts/base.html" %}

{% block title %}Evaluaciones de Docente{% endblock %} 

{% block stylesheets %}
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
  <style>
    .curso-card { margin-bottom: 1.5rem; border-radius: 8px; }
    .evaluacion-item { padding: 10px; border-radius: 6px; background-color: #f8f9fa; margin-bottom: 10px; }
    .evaluacion-item strong { color: #007bff; }
  </style>
{% endblock stylesheets %}

{% block content %}  
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <h1>Evaluaciones del Docente</h1>
      </div>
    </section>
    <section class="content">
      <div class="container-fluid">
        <div id="evaluaciones-list" class="row"></div>
      </div>
    </section>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="revisionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Seleccione el Método de Revisión</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="revisionForm">
            <div class="form-group">
              <label>Método de Análisis:</label><br>
              {% for method, label in {"tfidf": "Método TF-IDF", "ia_gemini": "Método IA Gemini"}.items() %}
              <div class="form-check">
                <input type="radio" class="form-check-input" id="{{ method }}" name="method" value="{{ method }}" {% if loop.first %}checked{% endif %} onclick="toggleMetricField()">
                <label class="form-check-label" for="{{ method }}">{{ label }}</label>
              </div>
              {% endfor %}
            </div>
            <div class="form-group" id="metricField" style="display: none;">
              <label for="metric">Métrica (obligatoria para IA Gemini):</label>
              <input type="text" id="metric" name="metric" class="form-control" placeholder="Introduce la métrica" required>
            </div>
            <div class="form-group">
              <label for="threshold">Threshold (0.00 - 1.00):</label>
              <input type="range" id="threshold" name="threshold" class="form-control-range" min="0" max="1" step="0.01" value="0.8" oninput="updateThresholdLabel(this.value)">
              <span id="thresholdValue">0.80</span>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="submitRevision()">Aplicar Revisión</button>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block javascripts %}
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/static/assets/js/adminlte.min.js"></script>
  <script>
    const evaluacionesList = document.getElementById('evaluaciones-list');
    const cardColors = ["bg-primary", "bg-success", "bg-info", "bg-warning", "bg-danger"];

    fetch("{{ url_for('evaluacion.get_evaluaciones_by_docente', dni_docente=current_user.dni) }}")
      .then(res => res.json())
      .then(data => {
        evaluacionesList.innerHTML = data.cursos?.length 
          ? data.cursos.map(curso => createCursoCard(curso)).join('') 
          : '<div class="col-12"><p class="text-center">No hay cursos asociados a este docente.</p></div>';
      })
      .catch(() => evaluacionesList.innerHTML = '<div class="col-12"><p class="text-center text-danger">Error al cargar las evaluaciones.</p></div>');
    
    const createCursoCard = curso => `
      <div class="col-md-6 col-lg-4">
        <div class="card curso-card shadow-sm">
          <div class="card-header ${cardColors[Math.floor(Math.random() * cardColors.length)]} text-white">
            <h5 class="card-title mb-0">${curso.curso.nombre}</h5>
            <small>ID Curso: ${curso.curso.id_curso}</small>
          </div>
          <div class="card-body">
            <h6>Evaluaciones:</h6>
            <div class="evaluaciones-list">
              ${curso.evaluaciones.length ? curso.evaluaciones.map(createEvaluacionItem).join('') : '<p class="text-muted">No hay evaluaciones para este curso.</p>'}
            </div>
          </div>
        </div>
      </div>`;
    
    const createEvaluacionItem = eval => `
      <div class="evaluacion-item">
        <strong>${eval.nombre}</strong><br>
        <small>${eval.descripcion}</small><br>
        <button class="btn btn-sm btn-primary mt-2" onclick="openRevisionModal(${eval.id_evaluacion})">Realizar Revisión</button>
      </div>`;
    
    const openRevisionModal = id => $('#revisionModal').data('idEvaluacion', id).modal('show');
    
    const toggleMetricField = () => {
      const method = document.querySelector('input[name="method"]:checked').value;
      const metricField = document.getElementById('metricField');
      if (method === 'ia_gemini') {
        metricField.style.display = 'block';
      } else {
        metricField.style.display = 'none';
      }
    };

    const updateThresholdLabel = value => document.getElementById('thresholdValue').textContent = parseFloat(value).toFixed(2);

    const submitRevision = () => {
      const idEvaluacion = $('#revisionModal').data('idEvaluacion');
      const method = document.querySelector('input[name="method"]:checked').value;
      const threshold = parseFloat(document.getElementById('threshold').value);
      let metric = null;

      // Si es IA Gemini, obtener la métrica
      if (method === 'ia_gemini') {
        metric = document.getElementById('metric').value;
        if (!metric) {
          alert('La métrica es obligatoria para el método IA Gemini.');
          return;
        }
      }

      // Enviar los datos del formulario, incluyendo la métrica si es IA Gemini
      const data = { idEvaluacion, method, threshold, metric };
      console.log(data);

      // Aquí agregarías la lógica para enviar los datos al servidor
    };
  </script>
{% endblock javascripts %}
